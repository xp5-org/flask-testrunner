{% extends "base.html" %}

{% block content %}


    <style>
        .spreadsheet { display: table; width: 100%; border-collapse: collapse; }
        .row { display: table-row; border-bottom: 1px solid #eee; }
        .cell { display: table-cell; padding: 6px; vertical-align: middle; }
        .label-cell { width: 30%; font-weight: bold; color: #444; font-size: 0.85em; background: #fafafa; border-right: 1px solid #eee; }
        
        select, input { width: 100%; padding: 4px 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 3px; font-size: 0.9em; }
        input[readonly] { background-color: #f9f9f9; color: #777; border-color: #ddd; font-family: monospace; font-size: 0.8em; }
        
        .section-head { background: #e9ecef; font-weight: bold; font-size: 0.8em; text-transform: uppercase; letter-spacing: 1px; }
        
        button { margin-top: 15px; padding: 10px; width: 100%; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; font-weight: bold; transition: background 0.2s; }
        button:hover { background: #0056b3; }
        
        #status { margin-top: 10px; padding: 8px; border-radius: 4px; font-size: 0.85em; white-space: pre-wrap; display: none; }
        .input-group { display: flex; align-items: center; }
        .prefix { background: #eee; padding: 4px 8px; border: 1px solid #ccc; border-right: none; border-radius: 3px 0 0 3px; font-size: 0.8em; color: #666; }
        .prefixed-input { border-radius: 0 3px 3px 0; }
    </style>



    <div id="main-content">
        <h2>Clone Build Test</h2>

        <div class="spreadsheet">
            <div class="row">
                <div class="cell label-cell">System Filter</div>
                <div class="cell"><select id="system-filter"><option value="all">All Systems</option></select></div>
            </div>

            <div class="row section-head"><div class="cell" colspan="2">1. Source Selection</div></div>
            
            <div class="row">
                <div class="cell label-cell">Source Test</div>
                <div class="cell"><select id="testlist" onchange="updateFields()"></select></div>
            </div>
            <div class="row">
                <div class="cell label-cell">Source Path</div>
                <div class="cell"><input type="text" id="src_path_display" readonly></div>
            </div>

            <div class="row section-head"><div class="cell" colspan="2">2. Target Definition</div></div>

            <div class="row">
                <div class="cell label-cell">New project dir</div>
                <div class="cell"><input type="text" id="target_id" placeholder="Folder/Project Name"></div>
            </div>
            <div class="row">
                <div class="cell label-cell">Run button label</div>
                <div class="cell"><input type="text" id="target_type"></div>
            </div>
            <div class="row">
                <div class="cell label-cell">New Dir Path</div>
                <div class="cell"><input type="text" id="target_path"></div>
            </div>

            <div class="row section-head"><div class="cell" colspan="2">3. Configuration Settings</div></div>

            <div class="row">
                <div class="cell label-cell">Main C File</div>
                <div class="cell"><input type="text" id="cfg_cmainfile"></div>
            </div>
            <div class="row">
                <div class="cell label-cell">Arch Type</div>
                <div class="cell"><input type="text" id="cfg_archtype"></div>
            </div>
            <div class="row">
                <div class="cell label-cell">Platform</div>
                <div class="cell"><input type="text" id="cfg_platform"></div>
            </div>
            <div class="row">
                <div class="cell label-cell">VICE Config</div>
                <div class="cell"><input type="text" id="cfg_viceconf"></div>
            </div>
            <div class="row">
                <div class="cell label-cell">Linker Config</div>
                <div class="cell"><input type="text" id="cfg_linkerconf"></div>
            </div>
            <div class="row">
                <div class="cell label-cell">Testfile Name (primary sort key)</div>
                <div class="cell">
                    <div class="input-group">
                        <span class="prefix">__testfile__</span>
                        <input type="text" id="cfg_testfile" class="prefixed-input">
                    </div>
                </div>
            </div>
        </div>

        <button onclick="cloneProject()">Execute Clone Operation</button>
        <div id="status"></div>
    </div>

    <script>
let allTestData = [];
let currentProjBase = ""; // Global to store the base directory

function loadTests() {
    fetch('/testfile_list')
        .then(r => r.json())
        .then(data => {
            allTestData = data;
            const systemFilter = document.getElementById('system-filter');
            const systemsSet = new Set();
            data.forEach(item => { if (item.system) systemsSet.add(item.system); });
            Array.from(systemsSet).sort().forEach(sys => {
                const opt = document.createElement('option');
                opt.value = sys; opt.textContent = sys;
                systemFilter.appendChild(opt);
            });
            renderTests('all');
        });
}

function renderTests(filter) {
    const sel = document.getElementById('testlist');
    sel.innerHTML = '<option value="">-- Select Source Test --</option>';
    let filtered = filter === 'all' ? allTestData : allTestData.filter(item => item.system === filter);
    filtered.sort((a, b) => (a.id || "").localeCompare(b.id || ""));
    filtered.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item.module;
        opt.dataset.id = item.id;
        opt.dataset.primaryType = (item.types && Object.keys(item.types)[0]) || 'build';
        opt.textContent = `${item.id} [${Object.keys(item.types || {}).join(', ')}]`;
        sel.appendChild(opt);
    });
}

document.getElementById('system-filter').addEventListener('change', function() { renderTests(this.value); });

function updateFields() {
    const sel = document.getElementById('testlist');
    const selected = sel.options[sel.selectedIndex];
    if (!selected.value) return;

    document.getElementById('target_type').value = selected.dataset.primaryType;
    if (!document.getElementById('cfg_testfile').dataset.userEdited) {
        document.getElementById('cfg_testfile').value = selected.dataset.id;
    }

    fetch(`/module_path?src_module=${encodeURIComponent(selected.value)}`)
        .then(r => r.json())
        .then(res => {
            if (res.status === 'success' && res.config) {
                const cfg = res.config;
                const paths = cfg.paths || {};
                
                document.getElementById('src_path_display').value = paths.src || '';

                // Store projbasedir and setup Target ID
                currentProjBase = cfg.projbasedir || '';
                const targetIdValue = selected.dataset.id + '_copy';
                document.getElementById('target_id').value = targetIdValue;
                
                // Set initial Target Path
                document.getElementById('target_path').value = currentProjBase + targetIdValue + '/';

                loadConfigFields({
                    cmainfile: cfg.cmainfile || '',
                    archtype: cfg.archtype || '',
                    platform: cfg.platform || '',
                    viceconf: paths.viceconf || '',
                    linkerconf: cfg.linkerconf || ''
                });
            }
        });
}

document.getElementById('cfg_testfile').addEventListener('input', function() { this.dataset.userEdited = true; });

// Updated listener to use currentProjBase
document.getElementById('target_id').addEventListener('input', function() {
    const name = this.value.trim();
    if (currentProjBase && name) {
        document.getElementById('target_path').value = currentProjBase + name + '/';
    }
});

function cloneProject() {
    const status = document.getElementById('status');
    status.style.display = 'block';
    status.textContent = 'Initialising...';
    
    const payload = {
        src_module: document.getElementById('testlist').value,
        target_id: document.getElementById('target_id').value.trim(),
        target_type: document.getElementById('target_type').value.trim(),
        target_path: document.getElementById('target_path').value.trim(),
        cmainfile: document.getElementById('cfg_cmainfile').value.trim(),
        archtype: document.getElementById('cfg_archtype').value.trim(),
        platform: document.getElementById('cfg_platform').value.trim(),
        viceconf: document.getElementById('cfg_viceconf').value.trim(),
        linkerconf: document.getElementById('cfg_linkerconf').value.trim(),
        testfile_name: document.getElementById('cfg_testfile').value.trim()
    };

    fetch(`/clone_as_new?${new URLSearchParams(payload)}`)
        .then(r => r.json())
        .then(res => {
            status.textContent = res.status === 'success' ? 'Success! Path: ' + res.path : 'Error: ' + res.message;
            status.style.background = res.status === 'success' ? '#f0fff0' : '#fff0f0';
            status.style.color = res.status === 'success' ? 'green' : 'red';
        });
}

function loadConfigFields(cfg) {
    document.getElementById('cfg_cmainfile').value = cfg.cmainfile || '';
    document.getElementById('cfg_archtype').value = cfg.archtype || '';
    document.getElementById('cfg_platform').value = cfg.platform || '';
    document.getElementById('cfg_viceconf').value = cfg.viceconf || '';
    document.getElementById('cfg_linkerconf').value = cfg.linkerconf || '';
}

loadTests();
    </script>
{% endblock %}