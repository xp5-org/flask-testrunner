<!doctype html>
<html>
<head>
    <title>Test Runner</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            table-layout: fixed;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }

        tr:nth-child(odd) {
            background-color: #e0e0e0;
        }

        th:nth-child(1), td:nth-child(1) { width: 25%; }
        th:nth-child(2), td:nth-child(2) { width: 20%; }
        th:nth-child(3), td:nth-child(3) { width: 35%; }
        th:nth-child(4), td:nth-child(4) { width: 20%; }

        .green { background-color: #c8f7c5; }
        .red { background-color: #f7c5c5; }
        .gray { background-color: #eeeeee; }

        a {
            display: inline-block;
            line-height: 1;
            padding: 0;
            margin: 0;
            text-decoration: none;
        }
    </style>
</head>

<body>
    <p id="progress-status">Progress: Idle</p>

    <h2>Available Tests</h2>
    <div id="testfile-container"></div>

    <br><br>

    <h1>Most Recent</h1>
    {% if latest_summary %}
        <table>
            <tr><th>Test</th><th>Duration (s)</th><th>Status</th></tr>
            {% for test, duration, status in latest_summary %}
                <tr>
                    <td>{{ test }}</td>
                    <td>{{ duration }}</td>
                    <td class="{{ 'green' if status == 'PASS' else ('red' if status == 'FAIL' else 'gray') }}">{{ status }}</td>
                </tr>
            {% endfor %}
        </table>
    {% else %}
        <p>No reports found.</p>
    {% endif %}

    <br><br>

    <h2>Summaries</h2>
    <table>
        <tr><th>Report</th><th>Duration</th><th>Status</th></tr>
        {% for report, duration, status in summaries %}
            <tr>
                <td><a href="{{ url_for('view_report', filepath=report) }}">{{ report }}</a></td>
                <td>{{ duration }}</td>
                <td class="{{ 'green' if status == 'PASS' else ('red' if status == 'FAIL' else 'gray') }}">{{ status }}</td>
            </tr>
        {% endfor %}
    </table>

    <script>
   document.addEventListener("DOMContentLoaded", async () => {
    const status = document.getElementById("progress-status");
    let polling = false;
    let hasStartedRunning = false; // Guard to prevent reload loops

    const poll = async () => {
        try {
            const res = await fetch("/progress");
            const data = await res.json();
            
            if (data.step === "Done") {
                status.textContent = "Progress: Complete";
                // Only reload if this script instance actually saw a test running
                if (hasStartedRunning) {
                    polling = false;
                    setTimeout(() => location.reload(), 1000); 
                    return;
                }
                polling = false;
                return;
            }
            
            if (data.step !== "Idle") {
                polling = true;
                hasStartedRunning = true; // Mark that we are officially tracking a run
                status.textContent = `Progress: ${data.step} - ${data.test_name}`;
                setTimeout(poll, 3000);
            } else {
                polling = false;
                status.textContent = "Progress: Idle";
            }
        } catch (e) {
            setTimeout(poll, 3000);
        }
    };

    window.startTest = (file, id, type) => {
        if (polling) return;
        polling = true;
        hasStartedRunning = true; 
        status.textContent = `Progress: Starting ${id} (${type})...`;
        
        fetch(`/run/${file}`)
            .then(r => r.ok ? poll() : (polling = false))
            .catch(() => {
                polling = false;
                status.textContent = "Error: Could not reach server.";
            });
    };

    // 1. Initial poll
    poll();

    // 2. Load Table (using your existing container)
    const testRes = await fetch("/testfile_list");
    const testfiles = await testRes.json();
    const container = document.getElementById("testfile-container");
    
    const platforms = testfiles.reduce((acc, t) => {
        const p = t.platform || "Unknown";
        (acc[p] = acc[p] || []).push(t);
        return acc;
    }, {});

    for (const [platform, tests] of Object.entries(platforms)) {
        let html = `<h3>${platform}</h3><table><tr><th>ID</th><th>System</th><th>Run</th></tr>`;
        tests.forEach(test => {
            const buttons = Object.entries(test.types).map(([type, file]) => `
                <button onclick="startTest('${file}', '${test.id}', '${type}')">${type}</button>
            `).join("");
            html += `<tr><td>${test.id}</td><td>${test.system}</td><td>${buttons}</td></tr>`;
        });
        container.insertAdjacentHTML('beforeend', html + '</table>');
    }
});
    </script>
</body>
</html>
