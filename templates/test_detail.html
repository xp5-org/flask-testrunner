{% extends "base.html" %}

{% block content %}
<!-- {% include "navbar.html" %} -->

<div id="main-content" style="padding-top: 20px;">
    <h1>Test Details: {{ testname }}</h1>
    <p id="progress-status">Progress: Idle</p>

    <div class="test-grid">
        {% for test in test_info %}
            {% for type, internal in test.types.items() %}
                {% set status = test.latest_status[type] %}
                <div class="test-card {{ 'green' if status == 'PASS' else ('red' if status == 'FAIL' else 'gray') }}">
                    <div class="card-header"><strong>{{ type }}</strong></div>
                    <div class="card-body">
                        <div><strong>ID:</strong> {{ test.id }}</div>
                        <div><strong>System:</strong> {{ test.system or 'N/A' }}</div>
                        <div><strong>Platform:</strong> {{ test.platform or 'N/A' }}</div>
                        <div><strong>Status:</strong> {{ status or 'N/A' }}</div>
                    </div>
                    <button onclick="runTest('{{ internal }}')">Run {{ type }}</button>
                </div>
            {% endfor %}
        {% endfor %}
    </div>

    {% if failure_logs %}
        <h3>Recent Non-Passing Steps</h3>
        <div class="failure-log-list">
            {% for log in failure_logs %}
                <div class="log-item" style="border-left: 4px solid red; padding-left: 10px; margin-bottom: 15px;">
                    <strong>Test:</strong> {{ log.testparentname }} ({{ log.test_type }}) | <strong>Step:</strong> {{ log.name }}
                    {% if log.get('output') %}
                    <pre class="code-block">{{ log.output }}</pre>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    {% if latest_summary %}
    <h2>Most Recent Run</h2>
    <table>
        <thead>
            <tr>
                <th colspan="4" style="text-align: center; background: #eee;">
                    ID: {{ latest_summary[0].test_id.split('.')[-1] }}
                </th>
            </tr>
            <tr>
                <th>Step Name</th>
                <th>Duration (s)</th>
                <th>Status</th>
                <th></th> </tr>
        </thead>
        <tbody>
        {% for step in latest_summary %}
            <tr>
                <td>{{ step.step_name }}</td>
                <td>{{ step.duration }}</td>
                <td class="{{ 'green' if step.status == 'PASS' else ('red' if step.status == 'FAIL' else 'gray') }}">
                    {{ step.status }}
                </td>
                <td></td> </tr>
        {% endfor %}
        </tbody>
    </table>
    {% endif %}

    <h2>Reports History</h2>
    {% if reports %}
    <table>
        <thead>
            <tr>
                <th>Report File</th>
                <th>Duration</th>
                <th>Timestamp</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
        {% for report in reports %}
            <tr>
                <td><a href="/reports/{{ report.filepath }}" target="_blank">{{ report.filename }}</a></td>
                <td>{{ report.duration }}</td>
                <td>{{ report.timestamp }}</td>
                <td class="{{ 'green' if report.status == 'PASS' else ('red' if report.status == 'FAIL' else 'gray') }}">
                    {{ report.status }}
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No reports found for this test.</p>
    {% endif %}
</div>

<script>
let isPolling = false;

async function runTest(internalName) {
    const status = document.getElementById("progress-status");
    status.textContent = `Progress: Starting ${internalName}...`;

    try {
        const r = await fetch(`/run/${encodeURIComponent(internalName)}`);
        if (!r.ok) throw new Error("Failed to start test");
        
        if (!isPolling) {
            isPolling = true;
            poll();
        }
    } catch (err) {
        console.error(err);
        status.textContent = "Error: Could not start test.";
    }
}

async function poll() {
    const status = document.getElementById("progress-status");

    try {
        const res = await fetch("/progress");
        const data = await res.json();

        if (data.step === "Done") {
            if (isPolling) {
                status.textContent = "Progress: Complete - Updating...";
                isPolling = false;
                setTimeout(() => location.reload(), 1500);
            } else {
                status.textContent = "Progress: Idle";
            }
            return;
        }

        if (data.step !== "Idle") {
            isPolling = true;
            status.textContent = `Progress: ${data.step} - ${data.testid} (${data.testtype})`;
            setTimeout(poll, 2000);
        } else {
            status.textContent = "Progress: Idle";
            isPolling = false;
        }
    } catch (e) {
        console.error("Polling error:", e);
        setTimeout(poll, 5000);
    }
}

document.addEventListener("DOMContentLoaded", poll);
</script>


{% endblock %}