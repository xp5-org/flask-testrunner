<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test Details - {{ testname }}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { margin-bottom: 10px; }
        .info { margin-bottom: 20px; }
        .info div { margin: 5px 0; }
        button { padding: 8px 16px; font-size: 14px; cursor: pointer; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background-color: #f0f0f0; }
        .green { background-color: #c8f7c5; }
        .red { background-color: #f7c5c5; }
        .gray { background-color: #eeeeee; }
        a { text-decoration: none; color: #007BFF; }
        a:hover { text-decoration: underline; }
    </style>
<script>
let isPolling = false;


async function runTest(internalName) {
    const status = document.getElementById("progress-status");
    status.textContent = `Progress: Starting ${internalName}...`;

    try {
        const r = await fetch(`/run/${encodeURIComponent(internalName)}`);
        if (!r.ok) throw new Error("Failed to start test");
        
        if (!isPolling) {
            isPolling = true;
            poll();
        }
    } catch (err) {
        console.error(err);
        status.textContent = "Error: Could not start test.";
    }
}

async function poll() {
    const status = document.getElementById("progress-status");

    try {
        const res = await fetch("/progress");
        const data = await res.json();

        // Only reload if we were actively running a test
        if (data.step === "Done") {
            if (isPolling) {
                status.textContent = "Progress: Complete - Updating...";
                isPolling = false;
                setTimeout(() => location.reload(), 1500);
            } else {
                status.textContent = "Progress: Idle";
            }
            return;
        }

        if (data.step !== "Idle") {
            isPolling = true;
             status.innerText = `Progress: ${data.step} - ${data.testid}
            - ${data.step_name}
             - (${data.testtype})
             - ${data.testname}`;

            setTimeout(poll, 2000);
        } else {
            status.textContent = "Progress: Idle";
            isPolling = false;
        }
    } catch (e) {
        console.error("Polling error:", e);
        setTimeout(poll, 5000);
    }
}

// polling immediately when the page opens
document.addEventListener("DOMContentLoaded", () => {
    poll();
});
</script>


</head>

<body>



<h1>Test Details: {{ testname }}</h1>
<p id="progress-status">Progress: Idle</p>

<div class="grid-buttons">
    {% for test in test_info %}
        {% for type, internal in test.types.items() %}
            {% set status = test.latest_status[type] %}
            <div class="grid-item {{ 'green' if status == 'PASS' else ('red' if status == 'FAIL' else '') }}">
                <div><strong>ID:</strong> {{ test.id }}</div>
                <div><strong>System:</strong> {{ test.system or 'N/A' }}</div>
                <div><strong>Platform:</strong> {{ test.platform or 'N/A' }}</div>
                <div><strong>Status:</strong> {{ status or 'N/A' }}</div>
                <button onclick="runTest('{{ internal }}')">{{ type }}</button>
            </div>
        {% endfor %}
    {% endfor %}
</div>



</div>
{% if failure_logs %}
    <h3>Recent Non-Passing Steps</h3>
    <div class="failure-log-list">
        {% for log in failure_logs %}
            <div class="log-item" style="border-left: 4px solid red; padding-left: 10px; margin-bottom: 15px;">
                <strong>Test:</strong> {{ log.testparentname }} ({{ log.test_type }})<br>
                <strong>Step:</strong> {{ log.name }}<br>
                {% if log.get('output') %}
                <pre style="background: #1e1e1e; color: #d4d4d4; padding: 10px; overflow-x: auto;">{{ log.output }}</pre>
                {% endif %}
            </div>
        {% endfor %}
    </div>
{% endif %}


{% if latest_summary %}
<table>
    <thead>
        <tr>
            <th colspan="3">Most Recent: {{ latest_summary[0].test_id.split('.')[-1] }}</th>
        </tr>
        <tr>
            <th>Step</th>
            <th>Duration</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody>
    {% for step in latest_summary %}
        <tr>
            <td>{{ step.step_name }}</td>
            <td>{{ step.duration }}</td>
            <td class="{{ 'green' if step.status == 'PASS' else ('red' if step.status == 'FAIL' else 'gray') }}">{{ step.status }}</td>
        </tr>
    {% endfor %}
    </tbody>
</table>
{% else %}
<p>No recent test steps available.</p>
{% endif %}






<h2>Reports</h2>
{% if reports %}
<table>
    <thead>
        <tr>
            <th>Timestamp</th>
            <th>Report File</th>
            <th>Duration</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody>
    {% for report in reports %}
        <tr>
            <td>{{ report.timestamp }}</td>
            <td><a href="/reports/{{ report.filepath }}" target="_blank">{{ report.filename }}</a></td>
            <td>{{ report.duration }}</td>
            <td class="{{ 'green' if report.status == 'PASS' else ('red' if report.status == 'FAIL' else 'gray') }}">{{ report.status }}</td>
        </tr>
    {% endfor %}
    </tbody>
</table>

{% else %}
<p>No reports found for this test.</p>
{% endif %}
<style>
.buttons-container {
    display: flex;
    width: 100%;
    margin-bottom: 20px;
}

.left-half {
    width: 50%;
    padding-right: 10px;
    box-sizing: border-box;
}

.right-half {
    width: 50%;
    padding-left: 10px;
    box-sizing: border-box;
}

/* grid layout for buttons */
.grid-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 10px;
}

.grid-item.green {
    background-color: #c8f7c5; /* light green */
}

.grid-item.red {
    background-color: #f7c5c5; /* light red */
}

.grid-item {
    border: 1px solid #ccc;
    padding: 10px;
    text-align: center;
    background-color: #f9f9f9; /* default gray */
    box-sizing: border-box;
}

.grid-item button {
    width: 100%;
    margin-top: 5px;
}
</style>
</body>
</html>
