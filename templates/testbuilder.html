<!DOCTYPE html>
<html>
    
<head>
    <meta charset="utf-8">
    <title>Test Builder</title>
<style>
* { box-sizing: border-box; }

body {
    margin: 0;
    font-family: sans-serif;
    display: flex;
    flex-direction: row; /* Timeline left, Builder right */
    height: 100vh;
    overflow: hidden;
}

#timeline {
    width: 350px; /* Fixed width for the left sidebar */
    height: 100%;
    border-right: 1px solid #ccc;
    position: relative;
    padding: 20px 10px 20px 60px;
    overflow-y: auto;
    background: #f4f4f4;
}

#line {
    position: absolute;
    left: 30px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #bbb;
}


#builder {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: 100vh; /* Force full height */
    background: white;
}

#controls {
    flex-shrink: 0; /* Prevents controls from resizing */
    padding: 20px;
    border-bottom: 1px solid #eee;
    background: #fff;
}

#param-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 20px;
    overflow: hidden; /* Important for internal scrolling */
}

.step {
    position: relative;
    /* 5x Spacing: increased margin for breathing room */
    margin: 5px 0; 
    /* Perimeter: heavy padding for a larger click target */
    padding: 10px; 
    background: white;
    /* Square perimeter: clear solid border */
    border: 2px solid #ddd; 
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: all 0.2s ease;
    /* Shadow makes the "hit area" more visible */
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.step:hover {
    border-color: #bbb;
    background: #fdfdfd;
}

.dot {
    position: absolute;
    /* Keeps the dot on the timeline line regardless of step size */
    left: -38px;
    top: 50%;
    transform: translateY(-50%);
    width: 14px;
    height: 14px;
    background: #333;
    border-radius: 50%;
    border: 3px solid #fff;
    z-index: 2;
}

.selected {
    background: #eef6ff;
    border-color: #007bff;
    border-width: 2px;
    font-weight: bold;
    box-shadow: 0 4px 8px rgba(0, 123, 255, 0.15);
}

/* Make the text inside the step take up the space */
.step span {
    flex: 1;
    pointer-events: none; /* Clicks pass through to the div */
}

#param-table-wrapper {
    height: 150px; 
    overflow-y: auto;
    border: 1px solid #eee;
    margin-bottom: 10px;
    flex-shrink: 0; /* Prevents table area from shrinking */
}

#param-table {
    width: 100%;
    border-collapse: collapse;
}

/* FIX: Ensure the JSON output takes the remaining space and stays there */
pre#output {
    flex: 1;
    background: #222;
    color: #adff2f;
    padding: 15px;
    border-radius: 4px;
    overflow: auto;
    font-family: monospace;
    margin: 0;
}

/* Fix for the highlight jumping */
.json-highlight {
    background-color: rgba(0, 123, 255, 0.15);
    border-left: 4px solid #007bff;
    display: block; 
    margin: 0 -15px; /* Pulls the highlight into the padding of the <pre> */
    padding: 0 15px;
    width: calc(100% + 30px);
}

button { padding: 6px 12px; cursor: pointer; }
.primary-btn { background: #007bff; color: white; border: none; border-radius: 4px; }


/* #param-split {
    flex: 1;
    display: flex;
    gap: 20px;
    overflow: hidden;
} */

#param-split {
    flex: 0 0 20%;
    min-height: 180px;
}


#param-left {
    width: 50%;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

#param-right {
    width: 50%;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

</style>

</head>

<body style="margin:0; height:100vh; display:flex; flex-direction:column;">

    <!-- Navbar at top -->
    <header style="height:50px; width:100%; background:#007bff; color:white; display:flex; align-items:center; padding:0 20px;">
        {% include "navbar.html" %}
    </header>

    <!-- Main content: timeline + builder -->
    <div style="flex:1; display:flex; flex-direction:row; overflow:hidden;">

        <!-- Timeline sidebar -->
        <div id="timeline" style="width:350px; border-right:1px solid #ccc; position:relative; padding:20px 10px 20px 60px; overflow-y:auto; background:#f4f4f4;">
            <div id="line" style="position:absolute; left:30px; top:0; bottom:0; width:2px; background:#bbb;"></div>
            <div id="steps"></div>
        </div>

        <!-- Builder main area -->
        <div id="builder" style="flex:1; display:flex; flex-direction:column; background:white; overflow:hidden;">

            <!-- Controls at top of builder -->
            <div id="controls" style="flex-shrink:0; padding:20px; border-bottom:1px solid #eee; display:flex; flex-direction:column; gap:10px;">
                <div class="row" style="display:flex; gap:20px; flex-wrap:wrap;">
                    <div class="group">
                        <label>System:</label>
                        <select id="system-filter" onchange="renderTests(this.value)">
                            <option value="all">All Systems</option>
                        </select>
                        <label>Source Test:</label>
                        <select id="testlist" onchange="updateFields()"></select>
                    </div>
                    
                    <div class="group">
                        <strong>Status:</strong> <span id="insertLabel">Insert at end</span>
                        <select id="moveTarget"></select>
                        <button onclick="moveStep()">Move Step</button>
                        <button onclick="sendSteps()" style="background:#28a745;color:white;border:none;border-radius:4px;margin-left:20px;">Sync to Flask</button>
                    </div>
                </div>
            </div>

            <!-- Parameter and JSON output area -->
            <div id="param-container" style="flex:1; display:flex; flex-direction:column; padding:20px; overflow:hidden;">
                
                <!-- Action + Parameters split -->
                <div id="param-split" style="display:flex; flex:0 0 auto; gap:20px; margin-bottom:10px;">
                    <div id="param-left" style="flex:1; display:flex; flex-direction:column; gap:10px;">
                        <label><strong>Action:</strong></label>
                        <select id="main"></select>
                        <hr style="width:100%; border:0; border-top:1px solid #eee;">
                        <button class="primary-btn" onclick="addStep()">Add Step</button>
                        <button onclick="updateStep()">Update Selected</button>
                    </div>

                    <div id="param-right" style="flex:1; display:flex; flex-direction:column; overflow:hidden;">
                        <label><strong>Parameters:</strong></label>
                        <div id="param-table-wrapper" style="height:150px; overflow-y:auto; border:1px solid #eee; flex-shrink:0;">
                            <table id="param-table">
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <label style="margin-top:10px;"><strong>JSON Output:</strong></label>
                <pre id="output" style="flex:1; background:#222; color:#adff2f; padding:15px; border-radius:4px; overflow:auto; font-family:monospace; margin:0;">{}</pre>

            </div>
        </div>
    </div>



<<script>
const schema = {{ schema|tojson }};
let steps = [];
let selectedIndex = null;
let allTestData = [];

const mainSel = document.getElementById("main");
const paramInput = document.getElementById("param");
const insertLabel = document.getElementById("insertLabel");
const moveTarget = document.getElementById("moveTarget");
const testListSel = document.getElementById("testlist");
testListSel.addEventListener('change', render);

Object.keys(schema).forEach(k => {
    const o = document.createElement("option");
    o.value = k;
    o.textContent = k;
    mainSel.appendChild(o);
});


function loadSub() {
    const currentAction = schema[mainSel.value];
    if (currentAction) {
        Object.keys(currentAction).forEach(k => {
            const o = document.createElement("option");
            o.value = k;
            o.textContent = k;
        });
    }
}


mainSel.onchange = () => {
    loadSub();
    renderParamTable(schema[mainSel.value] || {}); // remove [subSel.value]
};


function loadTests() {
    fetch('/testfile_list')
        .then(r => r.json())
        .then(data => {
            allTestData = data;
            const systemFilter = document.getElementById('system-filter');
            const systemsSet = new Set();
            
            data.forEach(item => {
                if (item.system) {
                    systemsSet.add(item.system);
                }
            });

            const sortedSystems = Array.from(systemsSet).sort((a, b) => a.localeCompare(b));
            sortedSystems.forEach(sys => {
                const opt = document.createElement('option');
                opt.value = sys;
                opt.textContent = sys;
                systemFilter.appendChild(opt);
            });

            renderTests('all');
        });
}


function renderTests(filter) {
    const testListSel = document.getElementById("testlist");
    testListSel.innerHTML = "<option value=''>-- Select a Test --</option>";
    
    const filtered = filter === 'all' 
        ? allTestData 
        : allTestData.filter(t => t.system === filter);

    filtered.forEach(test => {
        const opt = document.createElement("option");
        opt.value = test.module; 
        opt.textContent = test.display_name;
        testListSel.appendChild(opt);
    });
}


function updateFields() {
    const testSlug = document.getElementById("testlist").value;
    if (!testSlug) return;

    fetch(`/api/teststeps/${testSlug}`)
        .then(r => {
            if (!r.ok) throw new Error(`HTTP error! status: ${r.status}`);
            return r.json();
        })
        .then(data => {
            steps = data;
            selectedIndex = null;
            render();
        })
        .catch(err => {
            console.error("Fetch error:", err);
        });
}


function createStepObject() {
    const currentAction = mainSel.value;
    const templateParams = schema[currentAction] || { "string": "" };
    const finalParams = getParamValuesFromTable();

    return {
        action: currentAction,
        param: finalParams,
        subaction: "" 
    };
}


function addStep() {
    const newStep = createStepObject();
    if (selectedIndex === null) {
        steps.push(newStep);
    } else {
        steps.splice(selectedIndex + 1, 0, newStep);
    }
    render();
}


function updateStep() {
    if (selectedIndex === null) return;
    steps[selectedIndex] = createStepObject();
    render();
}


function selectStep(index) {
    selectedIndex = (selectedIndex === index) ? null : index;
    if (selectedIndex !== null) {
        const s = steps[selectedIndex];
        mainSel.value = s.action;
        renderParamTable(schema[s.action] || {}, s.param);
    } else {
        renderParamTable({}, {});
    }
    render();
}


function renderHighlightedJSON() {
    const outputPre = document.getElementById("output");
    const currentTestModule = document.getElementById("testlist").value;
    const jsonObj = { testid: currentTestModule, steps: steps };

    function renderValue(value, parentKey = null, index = null, depth = 0) {
        const indent = "  ".repeat(depth);
        const childIndent = "  ".repeat(depth + 1);

        if (Array.isArray(value)) {
            if (value.length === 0) return "[]";
            const items = value.map((v, i) => {
                const isSelected = (parentKey === "steps" && i === selectedIndex);
                const valStr = renderValue(v, parentKey, i, depth + 1);
                const comma = (i === value.length - 1) ? "" : ",";
                
                // If selected comma stays outside span
                if (isSelected) {
                    return `<span class="json-highlight">${valStr}</span>${comma}`;
                }
                return valStr + comma;
            });
            return `[\n${items.join("\n")}\n${indent}]`;
        } 
        
        if (value && typeof value === "object") {
            const props = Object.keys(value).map(k => {
                const val = renderValue(value[k], k, null, depth + 1);
                return `${childIndent}"${k}": ${val}`;
            });
            return `{\n${props.join(",\n")}\n${indent}}`;
        } 
        
        if (typeof value === "string") return `"${value}"`;
        return String(value);
    }

    outputPre.innerHTML = renderValue(jsonObj, null, null, 0);
}


function moveStep() {
    if (selectedIndex === null || steps.length < 2) return;
    const targetIdx = parseInt(moveTarget.value);
    const itemToMove = steps.splice(selectedIndex, 1)[0];
    let adjustedIdx = targetIdx;
    if (targetIdx > selectedIndex) {
        adjustedIdx = targetIdx - 1;
    }
    steps.splice(adjustedIdx, 0, itemToMove);
    selectedIndex = adjustedIdx;
    render();
}


function render() {
    const stepsDiv = document.getElementById("steps");
    stepsDiv.innerHTML = "";
    moveTarget.innerHTML = "";

    steps.forEach((s, i) => {
        const d = document.createElement("div");
        d.className = "step" + (i === selectedIndex ? " selected" : "");
        
        const dot = document.createElement("div");
        dot.className = "dot";
        d.appendChild(dot);

        const text = document.createElement("span");
        text.textContent = `Step ${i + 1}: ${s.action} / ${s.subaction}`;
        d.appendChild(text);

        const delBtn = document.createElement("button");
        delBtn.textContent = "âœ–";
        delBtn.style.cssText = "margin-left: 10px; color: white; background: red; border: none; border-radius: 3px; width: 20px; height: 20px; font-size: 12px; cursor: pointer;";
        delBtn.onclick = (e) => {
            e.stopPropagation();
            if (confirm("Delete this step?")) {
                steps.splice(i, 1);
                if (selectedIndex === i) selectedIndex = null;
                render();
            }
        };
        d.appendChild(delBtn);
        d.onclick = () => selectStep(i);
        stepsDiv.appendChild(d);
    });

    for (let i = 0; i <= steps.length; i++) {
        const opt = document.createElement("option");
        opt.value = i;
        if (i === 0) opt.textContent = "1. The very start";
        else if (i === steps.length) opt.textContent = (i + 1) + ". The very end";
        else opt.textContent = (i + 1) + ". Between Step " + i + " and " + (i + 1);
        moveTarget.appendChild(opt);
    }

    if (selectedIndex === null) {
        insertLabel.textContent = "Insert at end (" + steps.length + " steps total)";
        moveTarget.disabled = true;
    } else {
        insertLabel.textContent = "Editing Step " + (selectedIndex + 1);
        moveTarget.disabled = false;
        moveTarget.value = selectedIndex; 
    }

    const currentTestModule = document.getElementById("testlist").value;
    renderHighlightedJSON();
}


function sendSteps() {
    const testListSel = document.getElementById("testlist");
    const selectedModule = testListSel.value;
    const selectedText = testListSel.options[testListSel.selectedIndex]?.text;

    if (!selectedModule) {
        alert("Please select a Source Test first.");
        return;
    }

    const payload = {
        testid: selectedModule,
        testname: selectedText,
        testtype: "dispatchtest",
        steps: steps
    };

    fetch("/testbuilder", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === "ok") {
            alert("Saved: " + data.message);
        } else {
            alert("Error: " + data.message);
        }
    })
    .catch(err => alert("Failed to sync: " + err));
}


function renderParamTable(templateParams, currentValues={}) {
    const tbody = document.querySelector("#param-table tbody");
    tbody.innerHTML = "";
    
    Object.keys(templateParams).forEach(key => {
        const tr = document.createElement("tr");
        
        const tdKey = document.createElement("td");
        tdKey.textContent = key;
        tr.appendChild(tdKey);

        const tdVal = document.createElement("td");
        const input = document.createElement("input");
        input.type = "text";
        input.value = (currentValues[key] !== undefined) ? currentValues[key] : templateParams[key];
        input.dataset.paramKey = key;
        tdVal.appendChild(input);
        tr.appendChild(tdVal);

        tbody.appendChild(tr);
    });
}


function getParamValuesFromTable() {
    const values = {};
    document.querySelectorAll("#param-table input").forEach(inp => {
        values[inp.dataset.paramKey] = inp.value;
    });
    return values;
}


loadTests();
render();


</script>
</body>
</html>